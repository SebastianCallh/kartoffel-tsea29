\documentclass{article}
\usepackage[utf8]{inputenc}
\usepackage[english, swedish]{babel}

\usepackage{caption}
\usepackage{graphicx}
\usepackage{float}
\usepackage{textcomp}
\usepackage[yyyymmdd]{datetime}
\renewcommand{\dateseparator}{-}

\usepackage{graphicx}
\graphicspath{ {images/} }

%For headers & footers
\usepackage{fancyhdr}
\pagestyle{fancy}
\lhead{\includegraphics[scale=0.2]{Logo}}
\chead{Kartrobot}
\rhead{\today}

\lfoot{Konstruktion med mikrodatorer}
\rfoot{Grupp 3}

\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}


\title{Systemskiss}
\author{Patrik Sletmo}
\date{\today}

\selectlanguage{swedish}

\begin{document}

\thispagestyle{empty}

{
\sffamily
\centering
\large


{\huge 
Systemskiss
}

{\large
Patrik Sletmo
}

{\large
Version x.y
}

\vspace{3.5cm}

Status
\begin{center}
\begin{tabular}{ | c | c | c | } 
\hline
Granskad & snubbe & 2016-mm-dd \\
\hline
Godkänd & snubba & 2016-mm-dd\\
\hline
\end{tabular}
\end{center}
}
\clearpage

\vspace*{\fill}
{
\sffamily
\centering
\large


{\huge
Projektidentitet
}

{\large
Grupp 3, 16/HT, KarToffel \\ Linköpings tekniska högskola, institution
}

\vspace{0.5cm}

\begin{table}[H]
\centering
\begin{tabular}{ | c | c | c | c |}
\hline
Namn & Ansvar & Telefon & E-post \\
\hline
Patrik Sletmo & Projektledare & 070 783 57 61 & patsl736@student.liu.se \\
\hline
Rebecca Lindblom &  & 073 436 40 79 & rebli156@student.liu.se \\
\hline
Matildha Sjöstedt &  & 070 515 84 11 & matsj696@student.liu.se \\
\hline
Sebastian Callh &  & 073 820 46 64 & sebca553@student.liu.se \\
\hline
Anton Dalgren &  & 076 836 51 56 & antda685@student.liu.se \\
\hline
Matilda Dahlström &  & 070 636 33 52 & matda715@student.liu.se \\
\hline
\end{tabular}
\end{table}
}

\begin{center}
\textbf{Hemsida}: https://github.com/SebastianCallh/kartoffel-tsea29
\end{center}

\begin{center}
\textbf{Kund}: Mattias Krysander, 013 - 28 2198 , matkr@isy.liu.se
\end{center}

\begin{center}
\textbf{Kursansvarig}: Tomas Svensson, 3B 528, +46 (0)13 28 1368, tomas.svensson@liu.se \\
\textbf{Handledare}: Ännu ej bestämt
\end{center}
\vspace*{\fill}
\clearpage

\renewcommand*\contentsname{Innehållsförteckning}
\tableofcontents
\clearpage


{
\sffamily
\centering
\large


{\huge 
Dokumenthistorik \\
}
Status
\begin{center}
\begin{tabular}{ | c | c | c | c | c |} 
\hline
\textbf{Version} & \textbf{Datum} & \textbf{Utförda ändringar} & \textbf{Utförd av } & \textbf{Granskad} \\  
\hline
0.1 & 2016-09-xx & Första utkastet &  john doe & icke \\
\hline
\end{tabular}
\end{center}
}

\clearpage


\section{Inledning}
Den här systemskissen beskriver i mer teknisk detalj konstruktionen av roboten och tillhörande mjukvara. Dokumentet ska reflektera vår faktiska relisation av projektet och kan mycket väl komma att ändras allt eftersom projektet fortskrider och designbesluts behöver omvärderas.

\section{Systemöversikt}
Övergripande text om moduler, bussar, dylikt
Blockschema över roboten

\section{Huvudenhet}

Huvudenheten består av två undermoduler, logikenheten och kommunikationsenheten (se figur ~\ref{fig:huvudenhet}). Logikenheten fattar robotens alla beslut genom att betrakta sensordata från sensorenheten och sedan beordra styrenheten att navigera på lämpligt sätt, och kommunikationsenheten hanterar all kommunikation med mjukvaruklienten. 

\begin{figure}[H]
  \centering
  \includegraphics[scale=0.5]{Huvudenhet} \\
  \caption{Ett övergripande blockschema över huvudenheten}
  \label{fig:huvudenhet}
\end{figure}

\subsection{Realisering}

\begin{figure}[H]
\centering
\includegraphics[scale=0.25]{Huvudmodul_oversikt_blockschema}
\caption{Översiktsblockschema över huvudenheten}
\label{fig:huvudmodul}
\end{figure}

Figur~\ref{fig:huvudmodul} visar hur kommunikationen sker inom huvudenheten på ett översiktligt plan. Processorn innehåller minne där vi kommer lagra data, variabler, konstanter samt själva programmet som styr huvudenhetens logik (se \textit{Logikenhet}). Processorn kommunicerar till omvärlden på två sätt, via en Bluetoothenhet och via en I2C-buss. Kommunikationen via Bluetooth bygger på en slags handskakningsprincip mellan processorn och den PC som Bluetoothenheten är kopplad till. Processorn skickar signalen \textit{Clear to send} till PC för att tala om att den är redo att ta emot data. PC:n skickar signalen \textit{Request to send} till processorn när den är redo att ta emot data. I2C-bussen används för kommunikation mellan huvud-, sensor- och styrenhet. Huvudenheten är ensam master på bussen och styr på så vis kommunikaitonen. Följdaktligen är den även ansvarig för att generera klockpulsen SCL. När antingen sensor- eller styrenheten är redo att skicka data eller låta huvudenheten läsa data, kommer de skicka ett interrupt till huvudenhetens processor. Den processor vi har tänkt att använda oss utav i huvuenhten är en ATmega1284 processor, med 128kB flashminne samt extra 20 kB för variabler och konstanter och en klocka på 0-20 MHz.
 
\subsection{Kommunikationsenhet}
All kommunikation med mjukvaruklienten sker över Bluetooth.

Flödesdiagram här.

\subsection{Logikenhet}
Logikenheten gör det mesta tunga lyftandet. Den hanterar både navigationsbeslut och själva kartläggandet. Utöver det styr den också kommunikationen på L2C-bussen.

\subsubsection{Navigation}
Bild på navigation

\subsubsection{Kartläggning}

Allt eftersom roboten utforska den omkringliggande miljön kommer den att spara ned allt den upptäcker. Eftersom roboten rör sig under kartläggningen kommer nya hörn att behöva översättas till ett gemensamt koordinatsystem innan de sparas ned. Roboten löser det genom att vid start definera ett koordinatsystem med utgångspunkt där den startar och sedan, genom att veta sin egen position, översätta de nyupptäckta punkternas position till det ursprungliga koordinatsystemet med hjälp av vektoraddition. Se figur ~\ref{fig:Koordinatberakning} för ett exempel.

\begin{figure}[H]
  \centering
  \includegraphics[scale=0.5]{Koordinatberakning} \\
  \caption{En illustration över hur koordinater för nyfunna hörn beräknas innan de sparas. V är robotens ortsvektor, U hörnets vektor i förhållande till roboten och W hörnets ortsvektor.}
  \label{fig:Koordinatberakning}
\end{figure}

För att kartlägga omgivningen så konstruerar roboten upp en graf, med hörn som noder och väggar som bågar. För att detektera var hörn finns så läses lasersensorn av med jämna mellanrum. Vi kan visualisera det avlästa avståndet som en funktion av laserns vinkel som i figur ss, där diskontinuiteter och lokala maximum/minimum representerar hörn. En diskontinuitet betyder att vi hittat ett utstickande hörn med golvyta bakom sig och ett lokalt maximum/minimum innebär att vi hittat ett hörn på banan. Se figur ~\ref{fig:LaserDiskontinuitet} och figur ~\ref{fig:LaserLokaltMaximum} för exempel. Eftersom upplösningen på avläsningar på korta avstånd och långa avstånd kan skilja sig mycket kommer värdemängden defineras på ett interval där en jämförelse mellan mätningarna fortfarande är meningfull.

\begin{figure}[H]
  \centering
  \includegraphics[scale=0.5]{Laserfunktionskurva} \\
  \caption{En linjär-interpolerad bild utav avståndsavläsningar från lasersensorn där x är vår sensors vinkel och y det uppmätt avståndet.}
  \label{fig:laserfunktionskurva}
\end{figure}

I figur ~\ref{fig:laserfunktionskurva} kommer punkten som ligger på (1, 0.5) sparas, tillsammans med en båge till punkten som ligger på (2, 1). Eftersom vi här upptäcker en diskontinuitet så kommer ingen båge sparas mellan (2, 1) och (2, 3), men bågar kommer ansluta (2, 3) till (3, 4) och (3, 4) till (4, 2).

\begin{figure}[H]
  \centering
  \includegraphics[scale=0.5,keepaspectratio]{LaserDiskontinuitet} \\
  \caption{Ett fall där laseravståndsgrafen kommer innehålla en diskontinuitet.}
  \label{fig:LaserDiskontinuitet}
\end{figure}

\begin{figure}[H]
  \centering
  \includegraphics[scale=0.5]{LaserLokaltMaximum} \\
  \caption{Ett fall där laseravståndsgrafen kommer innehålla ett lokalt maximum.}
  \label{fig:LaserLokaltMaximum}
\end{figure}



\section{Styrenhet}
\begin{figure}[H]
\centering
\includegraphics[scale=0.35]{styrenhet_blockschema}
\caption{Översiktsblockschema över styrenheten}
\label{fig:styrenhet}
\end{figure}
Styrenheten (figur~\ref{fig:styrenhet}) är över gränssnittet I2C kopplad till huvudenheten.\newline\newline
Styrenheten (figur~\ref{fig:styrenhet}) har en processor av typ ATmega1284.\newline\newline
Styrenheten (figur~\ref{fig:styrenhet}) har fyra hjulservon indelade i två hjulpar. De två hjulparen kan styras oberoende av varandra. Dessa kontrollerar robotens position och kommunicerar med processorn med PWM och en riktningssignal.\newline\newline
Styrenheten (figur~\ref{fig:styrenhet}) har även ett rotationsservo som kontrollerar en avståndssensors rörelse. Detta servo kommunicerar med processorn via en half-duplex UART.\newline\newline

\subsection{Rotation}
Styrenhetens (figur~\ref{fig:styrenhet}) rotationsservo kommer att ha två sensorer fastsatta på sig, en avståndssensor samt ett gyro. Dessa sensorer hör till sensorenheten och kommer inte att kommunicera direkt med styrenheten. Sensordata processeras av sensorenheten och skickas sedan till huvudenheten. Därefter tas ett beslut i huvudenheten baserat på sensorenhetens data hur rotationsservot ska styras. 


\section{Sensorenhet}

\begin{figure}[H]
\centering
\includegraphics[scale=0.5]{sensorenhet}
\caption{Översikt över sensorernas koppling till sensorenheten}
\label{fig:sensorenhet}
\end{figure}
Sensorenheten (figur~\ref{fig:sensorenhet}) är kopplad till huvudenheten över gränssnittet I2C.\newline\newline
Sensorenheten (figur~\ref{fig:sensorenhet}) ska ha en lasersensor kopplad till sig som kommunicerar med processorn över PWM.\newline\newline
Sensorenheten (figur~\ref{fig:sensorenhet}) ska ha en accelerometer och gyrosensor kopplad till sig som ska hålla koll på hur mycket roboten har roterat och hur snabbt den åker. Dessa kommunicerar med varandra över SPI. \newline\newline
Sensorenheten (figur~\ref{fig:sensorenhet}) ska ha en rotationssensor kopplad till sig som håller koll på hur mycket lasersensorn har roterat. Dessa kommunicerar med varandra över SPI. \newline\newline
Sensorenheten (figur~\ref{fig:sensorenhet}) ska ha en knapp kopplad till sig på en av interrupt pinarna. Detta gör att när knappen trycks ned så växlar vi mellan autonomt och manuellt styrläge på roboten. \newline\newline

\subsection{Avståndssensor}
För att med så hög precision som möjligt kunna mäta avståndet till de kringläggande väggarna använder sig roboten av en LIDAR-Lite v2 laseravståndsmätare. Denna sensor är monterad tillsammans med ett servo på toppen av roboten för att kunna rotera fram och tilbaka och mäta avstånd i 360\textdegree. Den sensordata som rapporteras av lasern kombineras med data från ett gyro som också monterats på rotationsservot för att kunna ge en beskrivning av området runt roboten.

\subsubsection{Begränsningar}
Att montera två sensorer på en roterande del medför en del problem med hur t.ex. sladdar hanteras. Servot måste rotera i svepande rörelser fram och tillbaka för att inte dra sönder sladdarna och längden på sladdarna får inte vara för lång för att undvika att de hamnar ivägen.

\subsubsection{Rotation}
För att både kunna leverera korrekt data till huvudenheten samt undvika att förstöra hårdvaran på grund av utdragna sladdar behöver detektionen av sensorservots nuvarande rotation hålla sig innanför en viss felmarginal. Dels så rapporterar servot AX-12 sin nuvarande rotationsvinkel via dess dataport och dels kommer gyrosensorn ge en uppskattning om hur servot roterat. Blir felet för stort kan AX-12-servots rotation manuellt ändras till en given vinkel. I och med att data om rotationen kommer rapporteras från både sensorenheten (gyro) och styrenheten (servo) så sker beräkningen av vinkeln i huvudenheten.

\subsubsection{Montering}
\begin{figure}[H]
\centering
\includegraphics[scale=0.45]{Montering}
\caption{Skiss över montering av laser}
\label{fig:montering}
\end{figure}
Ett AX-12-servo monteras ovanpå roboten i mitten (se figur~\ref{fig:montering}). Ovanpå servot monteras laseravståndssensorn som i sin tur har gyrot monterat ovanpå. Från både servot och gyrot går fria sladdar som är kopplade till sensorenheten. De sladdar som behövs för att koppla in servot kommer inte ligga ivägen för rotationen och är därför undantagna från figuren. Förslagsvis går någon sorts ränna på båda sidorna av rotationstornet där sladdarna kan röra sig fritt (ej inkluderat i figur).

\section{Mjukvaruklient}
\begin{figure}[H]
\centering
\includegraphics[scale=0.3]{mjukvaruklient_flowchart2}
\caption{Översiktligt flödesschema över mjukvaruklienten}
\label{fig:mjukvaruklient}
\end{figure}
Mjukvaruklienten ska presentera den karta som med robotens hjälp genererats över rummet, samt låta användaren styra roboten när den är i sitt manuella läge. Ovanstående figur (~\ref{fig:mjukvaruklient}) visar ett översiktligt flödesschema av hur mjukvaruklienten fungerar. Mjukvaruklienten kommunicerar med roboten via Bluetooth. När data tas emot så ska denna sorteras utifrån om det är kartdata, mätdata eller styrdata - vilket kommer kännas igen av någon form av ID i början av överföringen. Datan lagras sedan tills klienten är redo att behandla den för presentation, vilket ska ske löpande - dvs. data ska presenteras och kartan växa fram allt eftersom roboten kör. Kommandon för att styra roboten manuellt skickas via Bluetooth till roboten. En lista på kommandon som ska kunna skickas till roboten kan återfinnas i kravspecifikationen. Som ett sekundärt krav har vi att man ska kunna byta mellan manuellt och autonomt läge genom mjukvaruklienten (detta är ej illustrerat i figuren ovan). Signalerna RTS och CLS förklaras i avsnittet \textit{Huvudenhet}. 

\end{document}
